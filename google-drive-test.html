<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive Service Account Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Google Drive Service Account Test</h1>

    <div class="test-section warning">
        <h3>‚ö†Ô∏è Security Warning</h3>
        <p>This page contains service account credentials. Do not share this URL publicly.</p>
    </div>

    <div class="test-section">
        <h3>Service Account Details</h3>
        <p><strong>Email:</strong> drive-uploader@my-project-11111111111-469012.iam.gserviceaccount.com</p>
        <p><strong>Upload Destination:</strong> Root Directory (service account's main Drive)</p>
        <p><strong>Previous Folder:</strong> SWIISH (no longer needed)</p>
    </div>

    <div class="test-section">
        <h3>Test Authentication</h3>
        <button onclick="testAuthentication()">Test Basic Authentication</button>
        <button onclick="testBasicDriveAccess()">Test Drive API Access</button>
        <button onclick="testUploadEndpoint()">Test Upload Endpoint</button>
        <button onclick="clearLogs()">Clear Logs</button>
        <div id="results"></div>
    </div>

    <div class="test-section">
        <h3>Setup Instructions</h3>
        <p>‚úÖ <strong>No additional setup required!</strong></p>
        <p>Files will be uploaded directly to the service account's root directory.</p>
        <ol>
            <li>Click "Test Basic Authentication" to verify the service account works</li>
            <li>Try uploading a file in the main application</li>
            <li>Files will appear in the service account's main Google Drive</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>Console Logs</h3>
        <pre id="logs"></pre>
    </div>

    <script>
        const SERVICE_ACCOUNT_EMAIL = "drive-uploader@my-project-11111111111-469012.iam.gserviceaccount.com";
        const PRIVATE_KEY = `-----BEGIN PRIVATE KEY-----
MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQDX38J1C6cKFHvX
nT6nfnu2AOylcQeTnxhmSrXGJtE/J7dVwKShs8l6+sl6iS1ltOSN4Kqx3ZaY8f5Q
sD68KGvp2r4gmBrWctDWEViisAYzTCJ6IVBJt1q6TK/D8pTLwY+GCKXD7dH6goae
go+Bhg6DK+FD0BN3Dfbp79gs31vJbE1zD5hThjf/UJL40/MHnYvcF5zTWdzIkAmQ
Arp5ET1feRPEns3P2JohQII6OLptGkuH9hLJn5Mp1yfm8KnhUrQzgseD/caerp2o
/+kQRVChSUrXGyvPfjGng6fQJEHzRPhCWFoubP6CZ6rPKEN3l7h0coQERmaCYTTA
kD4KV2xzAgMBAAECggEAFNc2V8RrOO7nUdaNcPAmE1kdf49c8uR+H4oA6INg2h8E
dRPnEPFhdyz0/I53woTnN8dD024YFuXt7m5FcDbazDXg+xaUKLXm8XO1QeeKgbNM
9Mt4i9VWvfufUGR/9vfV2lPFZRf1mKC3TGBAaHm/tuwqkDhrWKgReV49WX+qxdQw
cOMKJzGH84bCkmXwGBwzhn75c6h1tEwUuCljB4LYhuxA4ouPNLPkpvX3FQIGT84a
6ngHCGPEQa829PNucEXARH1plFayxnLRz11mcIJYcUhJzRnqG0qdyB6ky3OBjxRQ
gLeKWLZSYGczojTD9N7P8ggY1YVhP/VTJBmBeBFi+QKBgQDyGNAfTdD8Beh0FARd
C1LgkQXJqL3oWZILZMVNPrLjqbSZnSM9/332xiUnpxLifgNEdY1cCP9ELXoxrnEE
+aULC8e1ToYApMazOBDmorL5T2algeiz19+IvVSXrHfA6il8XY/tS7+zvPnZ3Mz5
37vM1nEZ0FkvXairfbVkfo8jvQKBgQDkRW5oDzqrpUyFnoI0G29h6IaO9pRK/ZZU
bEw6VOA69/iuJ8nTDOFmq2Xh1rbYOVxEwKN78eqcNWURkOQs3h8shiPxzyt/sEhI
3vCix9mYhLdEiHkv20R32HwlTAB2Flfo76pRxBn31hNiGyqGVzX+wwauJzaKewCD
YIcH7qK77wKBgCn0/uzN8bAb3gNwDKmLctuUhqpCYldIXrU2y7LtcNdf6/rLbvYp
t0zzXjEXFYDHUg2lSdBvhr3sG8dMci3ojh/x9LSJXVPzOrSIvPUbsWTfy+xXLVst
yIHMPkLjEwYODw6MsIrxm9GsqKiHScbsbYG8kHFm2G4LD1ZZPPyjqm8JAoGAI0UP
EAj6WbcKocKh/4cVqJ0S3VgABa404gpxpLmkg7f4tn/zUSa2VPS6ozBXxATo2r6h
A++W/lfJq/MlLkGLs4duWlhWMj58jLXVnHEgj85ButcTUm+gnpvWYrThhV1ia91M
BaI1GPP8vrXP1j33W8uqZpIsfS0QITxy4KjggAUCgYBvElBnVlVdjd4/zwwIMZIi
gPamMFydqIFv55g2owURlsT9hz37+opqU17MspXw7vQaC4ko9zqpUCtbjG7LDhkh
FLBPzEDNAIh9dpyD84fhWPK06QKDcr3Tt6FbAQEj8upiZPhZk2Cini6B+zCzHs+7
9Mhhe/1nmnIdDMeHG4b5Ag==
-----END PRIVATE KEY-----`;

        let accessToken = null;
        const logs = [];

        function log(message) {
            logs.push(new Date().toLocaleTimeString() + ': ' + message);
            document.getElementById('logs').textContent = logs.join('\n');
            console.log(message);
        }

        async function generateJWT() {
            const header = {
                alg: 'RS256',
                typ: 'JWT',
            };

            const now = Math.floor(Date.now() / 1000);
            const payload = {
                iss: SERVICE_ACCOUNT_EMAIL,
                scope: 'https://www.googleapis.com/auth/drive',
                aud: 'https://oauth2.googleapis.com/token',
                exp: now + 3600,
                iat: now,
            };

            const encodedHeader = btoa(JSON.stringify(header)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            const encodedPayload = btoa(JSON.stringify(payload)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            const message = `${encodedHeader}.${encodedPayload}`;

            const signature = await signMessage(message, PRIVATE_KEY);
            return `${message}.${signature}`;
        }

        async function signMessage(message, privateKey) {
            const keyData = privateKey
                .replace(/-----BEGIN PRIVATE KEY-----/, '')
                .replace(/-----END PRIVATE KEY-----/, '')
                .replace(/\s/g, '');

            const binaryKey = Uint8Array.from(atob(keyData), c => c.charCodeAt(0));

            const cryptoKey = await crypto.subtle.importKey(
                'pkcs8',
                binaryKey,
                {
                    name: 'RSASSA-PKCS1-v1_5',
                    hash: 'SHA-256',
                },
                false,
                ['sign']
            );

            const signature = await crypto.subtle.sign('RSASSA-PKCS1-v1_5', cryptoKey, new TextEncoder().encode(message));
            return btoa(String.fromCharCode(...new Uint8Array(signature)))
                .replace(/=/g, '')
                .replace(/\+/g, '-')
                .replace(/\//g, '_');
        }

        async function initializeAuth() {
            try {
                log('üîê Generating JWT...');
                const jwt = await generateJWT();

                log('üîë Exchanging JWT for access token...');
                const tokenResponse = await fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
                        assertion: jwt,
                    }),
                });

                if (!tokenResponse.ok) {
                    const errorText = await tokenResponse.text();
                    log('‚ùå Token request failed: ' + errorText);
                    return false;
                }

                const tokenData = await tokenResponse.json();
                accessToken = tokenData.access_token;
                log('‚úÖ Authentication successful');
                return true;
            } catch (error) {
                log('‚ùå Authentication error: ' + error.message);
                return false;
            }
        }

        async function testAuthentication() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Testing authentication...</p>';

            const success = await initializeAuth();
            if (success) {
                results.innerHTML = '<p class="success">‚úÖ Authentication test passed!</p>';
            } else {
                results.innerHTML = '<p class="error">‚ùå Authentication test failed. Check console for details.</p>';
            }
        }

        async function testBasicDriveAccess() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Testing Drive API access...</p>';

            if (!accessToken) {
                const authSuccess = await initializeAuth();
                if (!authSuccess) {
                    results.innerHTML = '<p class="error">‚ùå Authentication failed first</p>';
                    return;
                }
            }

            try {
                // Test multiple Drive API endpoints
                const endpoints = [
                    'https://www.googleapis.com/drive/v3/about?fields=user',
                    'https://www.googleapis.com/drive/v3/files?pageSize=1',
                    'https://www.googleapis.com/drive/v3/files/generateIds?count=1'
                ];

                let successCount = 0;

                for (const endpoint of endpoints) {
                    log(`Testing: ${endpoint}`);
                    const response = await fetch(endpoint, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                        },
                    });

                    if (response.ok) {
                        const data = await response.json();
                        log(`‚úÖ ${endpoint} - Success`);
                        successCount++;
                    } else {
                        const errorText = await response.text();
                        log(`‚ùå ${endpoint} - Status: ${response.status} - ${errorText}`);
                    }
                }

                if (successCount > 0) {
                    results.innerHTML = `<p class="success">‚úÖ Drive API access test: ${successCount}/${endpoints.length} endpoints working</p>`;
                } else {
                    results.innerHTML = '<p class="error">‚ùå All Drive API endpoints failed</p>';
                }
            } catch (error) {
                results.innerHTML = '<p class="error">‚ùå Drive API test error: ' + error.message + '</p>';
                log('‚ùå Drive API test error: ' + error.message);
            }
        }

        async function testUploadEndpoint() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Testing upload endpoint...</p>';

            if (!accessToken) {
                const authSuccess = await initializeAuth();
                if (!authSuccess) {
                    results.innerHTML = '<p class="error">‚ùå Authentication failed first</p>';
                    return;
                }
            }

            try {
                const testResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=media', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'text/plain',
                        'Content-Length': '0',
                    },
                    body: '',
                });

                if (testResponse.ok) {
                    results.innerHTML = '<p class="success">‚úÖ Upload endpoint accessible</p>';
                    log('‚úÖ Upload endpoint test passed');
                } else {
                    const errorText = await testResponse.text();
                    results.innerHTML = `<p class="error">‚ùå Upload endpoint failed: ${testResponse.status}</p>`;
                    log(`‚ùå Upload endpoint failed: ${testResponse.status} - ${errorText}`);
                }
            } catch (error) {
                results.innerHTML = '<p class="error">‚ùå Upload endpoint test error: ' + error.message + '</p>';
                log('‚ùå Upload endpoint test error: ' + error.message);
            }
        }
    </script>
</body>
</html>
